version: "3.9"
services:
  # Enhanced Cali X One Core with SKG Intelligence
  cali-x-one:
    build: .
    ports: 
      - "8003:8003"  # Main service
    environment:
      - PYTHONPATH=/app:/app/skg-core
      - SKG_DB_PATH=/app/data/skg.db
      - CALEON_ENV=production
    volumes:
      - ./seed_vault:/app/seed_vault:ro
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - caleon
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    command: ["python", "-m", "uvicorn", "iss_module.api.api:app", "--host", "0.0.0.0", "--port", "8003"]

  # SKG API Service for direct knowledge graph operations
  skg-service:
    build: .
    ports:
      - "8004:8004"  # SKG service
    environment:
      - PYTHONPATH=/app:/app/skg-core
      - SKG_DB_PATH=/app/data/skg.db
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - caleon
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    command: ["python", "/app/skg-core/skg_api.py"]
    depends_on:
      - cali-x-one

  cochlear:
    build: ./services/cochlear-processor
    env_file: .env
    volumes:
      - ./seed_vault:/app/seed_vault:ro
      - ./runtime:/app/runtime
    networks:
      - caleon
    depends_on:
      - cali-x-one

  resonator:
    build: ./services/resonator-pyramid
    depends_on: 
      - cochlear
      - cali-x-one
    volumes:
      - ./seed_vault:/app/seed_vault:ro
    networks:
      - caleon

  anterior:
    build: ./services/anterior-helix
    ports: ["8001:8001"]
    volumes:
      - ./seed_vault:/app/seed_vault:ro
    networks:
      - caleon
    depends_on:
      - cali-x-one

  posterior:
    build: ./services/posterior-helix
    ports: ["8005:8005"]
    volumes:
      - ./seed_vault:/app/seed_vault:ro
    networks:
      - caleon
    depends_on:
      - cali-x-one

  gyro:
    build: ./services/gyro-harmonizer
    ports: ["8090:8090"]
    volumes:
      - ./seed_vault:/app/seed_vault:ro
    networks:
      - caleon

  phonatory:
    build: ./services/phonatory-output
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - ./seed_vault:/app/seed_vault:ro
    networks:
      - caleon

  # Advanced Vault System - Consciousness Framework
  vault-system:
    build: ./vault_system
    ports:
      - "8002:8002"  # Vault system API
      - "8001:8001"  # Telemetry dashboard
    environment:
      - PYTHONPATH=/app
      - VAULT_MASTER_KEY=master_key_2024
      - VAULT_NODE_ID=advanced_vault
    volumes:
      - ./vault_system:/app/vault_system
      - ./seed_vault:/app/seed_vault:ro
      - ./runtime:/app/runtime
      - ./logs:/app/logs
    networks:
      - caleon
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    command: ["python", "main.py"]
    depends_on:
      - cali-x-one

  vault-watch:
    image: hashicorp/consul-template
    volumes:
      - ./seed_vault:/app/seed_vault:ro
    command: -template "/app/seed_vault/index.json.ctmpl:/app/runtime/vault-reload.log" -exec "pkill -HUP seed-loader"
    networks:
      - caleon

networks:
  caleon:
    driver: bridge
